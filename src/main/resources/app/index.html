<!DOCTYPE html>
<!--
  ~ The MIT License (MIT)
  ~
  ~ Copyright (c) 2017 spinetrak
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in all
  ~ copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  ~ SOFTWARE.
  -->


<html>
<head>
    <title>rPI-PiTFT</title>
    <script type="text/javascript" src="smoothie.js"></script>
</head>
<body>
<div>
    <pre id="messages"></pre>
</div>
<h3>CPU</h3>
<canvas id="cpu" width="800" height="100"></canvas>
<h3>MEM</h3>
<canvas id="mem" width="800" height="100"></canvas>
<h3>TMP</h3>
<canvas id="tmp" width="800" height="100"></canvas>

<script type="text/javascript">

    function init() {
        startWebSocket();
    }

    var cpuLine = new TimeSeries();
    var memLine = new TimeSeries();
    var tmpLine = new TimeSeries();

    function startWebSocket() {
        websocket = new WebSocket("ws://192.168.2.111:8887");
        websocket.onopen = function (evt) {
            onOpen(evt)
        };
        websocket.onclose = function (evt) {
            onClose(evt)
        };
        websocket.onmessage = function (evt) {
            onMessage(evt)
        };
        websocket.onerror = function (evt) {
            onError(evt)
        };
    }

    function onMessage(evt) {
        var message = evt.data;
        var obj = JSON.parse(message);
        for (var [key, value] of Object.entries(obj)) {
            if ("_cpu" === key) {
                cpuLine.append(new Date().getTime(), value);
            }
            else if ("_memory" == key) {
                memLine.append(new Date().getTime(), value);
            }
            else if ("_temperature" == key) {
                tmpLine.append(new Date().getTime(), value);
            }
            //console.log(key + ' ' + value);
        }
        //writeToScreen(evt.data)
    }

    function onOpen(evt) {
        writeToScreen("CONNECTED: " + evt.data);
    }

    function onClose(evt) {
        writeToScreen("DISCONNECTED: " + evt.data);
    }

    function onError(evt) {
        writeToScreen("ERROR: " + evt.data);
    }

    function writeToScreen(message) {
        var messages = document.getElementById("messages");
        messages.style.wordWrap = "break-word";
        messages.innerHTML = message;
    }


    var cpuChart = new SmoothieChart({
        grid: {
            strokeStyle: 'rgb(125, 0, 0)',
            fillStyle: 'rgb(60, 0, 0)',
            lineWidth: 1,
            millisPerLine: 250,
            verticalSections: 6
        }
    });
    cpuChart.addTimeSeries(cpuLine, {strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3});
    cpuChart.streamTo(document.getElementById("cpu"), 1000);

    var memChart = new SmoothieChart({
        grid: {
            strokeStyle: 'rgb(125, 0, 0)',
            fillStyle: 'rgb(60, 0, 0)',
            lineWidth: 1,
            millisPerLine: 250,
            verticalSections: 6
        }
    });
    memChart.addTimeSeries(memLine, {strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3});
    memChart.streamTo(document.getElementById("mem"), 1000);

    var tmpChart = new SmoothieChart({
        grid: {
            strokeStyle: 'rgb(125, 0, 0)',
            fillStyle: 'rgb(60, 0, 0)',
            lineWidth: 1,
            millisPerLine: 250,
            verticalSections: 6
        }
    });
    tmpChart.addTimeSeries(tmpLine, {strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3});
    tmpChart.streamTo(document.getElementById("tmp"), 1000);

    window.addEventListener("load", init, false);

</script>
</body>
</html>